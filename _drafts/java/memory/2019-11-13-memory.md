---

---

# Java memory model - Основа

## Типы данных

Виртуальная машина Java оперирует двумя видами типов: примитивные и ссылочные типы. Примитивных типов существует всего лишь 8.

| **Типы данных** | Размер (bites) | **Дефолтное значение** |
| --------------- | -------------- | ---------------------- |
| byte            | 8              | 0                      |
| boolean         | 8              | false                  |
| short           | 16             | 0                      |
| char            | 16             | '\u0000'               |
| int             | 32             | 0                      |
| long            | 32             | 0L                     |
| float           | 64             | 0.0f                   |
| double          | 64             | 0.0d                   |

Cуществует три вида ссылочных типов:

- массивы,
- классы,
- интерфейсы.

При создании любого ссылочного типа создается объект и ссылка на этот объект. Можно провести аналогию, что объект - это телевизор, а ссылка - это пульт.

- Размер ссылок может быть 4 или 8 байт. 
- Размер объектов - ограничен только размером памяти.



### Как определить диапазон значений по размеру?

TODO



## Типы памяти JVM

### Регистр (`pc - program counter`)

Кадый поток `JVM` имеет собственный регистр (`pc - program counter`). Каждый поток выполняет в момент времени выполняет метод - текущий метод потока.

- Если выполняется `JVM` метод, то регистр хранит `returnAddress`.
- Если выполняется `native` метод, то значение регистра `undefined`.



### Стек (`Stack`)

При создании потока создается `stack`, который хранит:

- фреймы (`frame`), которые содержат:
  - локальные переменные,
  - промежуточные результаты,
  - возвращаемые значения и тд.

Размер стека может быть задан спомощью `-Xss`:

````bash
java -Xss4m Test
````

Если при вычистлениях требуется больше памяти, то бросится `StackOverflowError`.

> Интересно, что спецификация `JVM` позволяет реализовывать `JVM` c динамически расширяемым `stack`'ом и кидать `OutOfMemoryError`, в случае превышения памяти.



**NOTES -> TODO**

- Because the Java Virtual Machine stack is never manipulated directly except to push and pop frames, frames may be heap allocated. 
- The memory for a Java Virtual Machine stack does not need to be contiguous.



### Куча (`Heap `)

Куча (`heap`) доступен из всех потоков `JVM`. Куча - это область данных, из которой выделяется память для всех экземпляров и массивов классов.

Куча создается при старте `JVM`. Куча хранит объекты, которые под контролем `automatic storage management system`, известной как `garbage collector`. Объекты никогда не удаляются явно.

Спецификация `JVM` не предполагает конкретного типа автоматической системы управления хранением и методика управления хранением может быть выбрана в соответсвиями с требованиями разработчика.

Куча может быть фиксированого размера, может расширятся, если это требуется для вычислений, либо сжиматься, если место становится ненужным.

Если при вычистлениях требуется больше памяти, то бросится `OutOfMemoryError`.



### Method Area

`Method Area` доступна из всех потоков `JVM`. `Method Area` - это область данных, которая хранит скомпилированный код. Она хранит структуру для каждого класса, а имено:

- пул констант времени выполнения (`the run-time constant pool`),
- данные полей и методов,
- код методов и конструкторов,
- инициализацию экземпляра и интерфейса. (???)

Эта область создается при старте `JVM`. Хотя `Method Area` является логически частью хипа, простые реализации могут не собирать и не сжимать.

Данная спецификация не требует определенного расположения или политик используемых для скомпилированного кода.

Область может быть фиксированного размера или расширятся при вычислениях и может сжиматься, если место более не требудется.

Реализация `JVM` может предоставить програмисту или пользователю контроль над начальным размером `Method Area`, а также, в случае переменного размера, указывать минимальный и максимальный размер области.

Если при работе требуется больше памяти, то бросится `OutOfMemoryError`.



### Run-Time Constant Pool

`Run-Time Constant Pool` - таблица ( `constant_pool`) для констант, создается для каждого класса/интерфейса в `class file`.

Содержит несколько видов констант, начиная от числовых литералов и заканчивая ссылками на методы и поля, которые должны быть доступны в `run-time`.

`Run-time constant pool` выполняет функцию аналогичную функции таблицы символов обычного языка, хотя пул содержит более широкий диапазон данных, чем типичная таблица символов.

Каждый `run-time constant pool` выделяется из `Method Area`.

`Run-Time Constant Pool`  создается, когда создается класс/интерфейс в `JVM`.

Когда создается класс/интерфейс, и если для `Run-Time Constant Pool` создания не хватает памяти, то бросится `OutOfMemoryError`.



### Native Method Stacks



An implementation of the Java Virtual Machine may use conventional stacks, colloquially called "C stacks," to support `native` methods (methods written in a language other than the Java programming language). 

Native method stacks may also be used by the implementation of an interpreter for the Java Virtual Machine's instruction set in a language such as C.

 Java Virtual Machine implementations that cannot load `native` methods and that do not themselves rely on conventional stacks need not supply native method stacks.

If supplied, native method stacks are typically allocated per thread when each thread is created.

This specification permits native method stacks either to be of a fixed size or to dynamically expand and contract as required by the computation. If the native method stacks are of a fixed size, the size of each native method stack may be chosen independently when that stack is created.

A Java Virtual Machine implementation may provide the programmer or the user control over the initial size of the native method stacks, as well as, in the case of varying-size native method stacks, control over the maximum and minimum method stack sizes.



##  Frames



Пример программы!











The Java Virtual Machine expects that nearly all type checking is done prior to run time, typically by a compiler, and does not have to be done by the Java Virtual Machine itself.

The Java Virtual Machine contains explicit support for objects. An object is either a dynamically allocated class instance or an array

A reference to an object is considered to have Java Virtual Machine type `reference`



**Картинка**

![]({{ site.baseurl }}/img/functional-interfaces/1.png)



# Вопросы

1. Как диапазон значений по размеру, например для `int`?

   



Другие вопросы

1. Что такое `statically-typed`?
   - [The Java programming language is statically-typed, which means that all variables must first be declared before they can be used.](https://docs.oracle.com/javase/tutorial/java/nutsandbolts/datatypes.html)
2. Для чего можно и нельзя использовать `float` and `double` ?
3. Зачем существует класс `BigDecimal`?
4. [Почему "Relying on such default values, however, is generally considered bad programming style"?](https://docs.oracle.com/javase/tutorial/java/nutsandbolts/datatypes.html)



# Источники

1. [Primitive Data Types](https://docs.oracle.com/javase/tutorial/java/nutsandbolts/datatypes.html)
2. [The Structure of the Java Virtual Machine](https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html) 
3. 
4. [Википедия - Регистр процессора](https://ru.wikipedia.org/wiki/%D0%A0%D0%B5%D0%B3%D0%B8%D1%81%D1%82%D1%80_%D0%BF%D1%80%D0%BE%D1%86%D0%B5%D1%81%D1%81%D0%BE%D1%80%D0%B0)
5. https://www.oracle.com/webfolder/technetwork/tutorials/obe/java/gc01/index.html
6. https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/toc.html
7. https://www.baeldung.com/java-stack-heap



## [Скачать приложение]({{ site.baseurl }}/download/01-java/functional-interfaces.zip)